# BGS World Mineral Statistics Dashboard

## Project Overview

This is a professional, interactive dashboard built with Astro, React, and shadcn/ui for visualizing BGS (British Geological Survey) World Mineral Statistics data. The dashboard displays mineral production, imports, and exports data from 1970-2023.

## Tech Stack

- **Framework**: Astro 5.x with React 19
- **Package Manager**: Bun (NOT npm or pnpm)
- **Styling**: Tailwind CSS v4 with shadcn/ui components
- **Charts**: Recharts
- **Tables**: TanStack React Table v8
- **HTTP Client**: Axios
- **Icons**: Lucide React
- **TypeScript**: Strict mode enabled
- **Deployment**: GitLab Pages

## Project Structure

```
├── src/
│   ├── components/
│   │   ├── ui/                      # shadcn/ui components (auto-generated)
│   │   │   ├── button.tsx
│   │   │   ├── card.tsx
│   │   │   ├── select.tsx
│   │   │   ├── slider.tsx
│   │   │   ├── table.tsx
│   │   │   ├── badge.tsx
│   │   │   ├── input.tsx
│   │   │   ├── label.tsx
│   │   │   └── radio-group.tsx
│   │   ├── Dashboard.tsx            # Main dashboard component (client-side)
│   │   ├── FilterPanel.tsx          # Left sidebar filters
│   │   ├── TimeSeriesChart.tsx      # Line chart for trends
│   │   ├── ComparisonBarChart.tsx   # Bar chart for comparisons
│   │   ├── MineralDataTable.tsx     # Sortable data table
│   │   ├── MetricsCard.tsx          # Individual metric display
│   │   └── InsightsPanel.tsx        # Right sidebar with metrics
│   ├── pages/
│   │   ├── api/
│   │   │   └── minerals.ts          # API proxy endpoint (server-side)
│   │   └── index.astro              # Main entry page
│   ├── types/
│   │   └── minerals.ts              # TypeScript types & constants
│   ├── lib/
│   │   └── utils.ts                 # Utility functions (cn helper)
│   └── styles/
│       └── global.css               # Global styles & CSS variables
├── .gitlab-ci.yml                   # GitLab Pages deployment config
├── astro.config.mjs                 # Astro configuration
├── components.json                  # shadcn/ui configuration
├── tsconfig.json                    # TypeScript config with path aliases
└── package.json
```

## Important Conventions

### 1. Component Patterns

#### React Components
- Use `.tsx` extension for all React components
- All dashboard components are client-side only (use `client:load` in Astro)
- Follow functional component pattern with TypeScript interfaces for props
- Use named exports for main components

Example:
```tsx
interface MyComponentProps {
  data: SomeType[];
  onAction: () => void;
}

export function MyComponent({ data, onAction }: MyComponentProps) {
  // component code
}
```

#### Astro Pages
- Use `.astro` extension
- Import React components and use with `client:load` directive
- Keep Astro pages minimal - main logic should be in React components

### 2. Styling

#### Tailwind CSS v4
- This project uses Tailwind CSS v4 (NOT v3)
- **IMPORTANT**: Do NOT use `@apply` with custom utility classes
- Use direct CSS or inline Tailwind classes

**WRONG** (Tailwind v4 doesn't support custom utility classes in @apply):
```css
@layer base {
  * {
    @apply border-border;
  }
}
```

**CORRECT**:
```css
@layer base {
  * {
    border-color: hsl(var(--border));
  }
}
```

#### CSS Variables
- Theme colors are defined in `src/styles/global.css` using CSS custom properties
- Use HSL format: `hsl(var(--background))`
- Light and dark mode variables available

#### shadcn/ui Components
- Installed via: `bunx shadcn@latest add <component>`
- Components are in `src/components/ui/`
- Configuration in `components.json`
- Uses `@/` path alias (configured in tsconfig.json)

### 3. Path Aliases

TypeScript paths are configured:
- `@/components` → `./src/components`
- `@/lib` → `./src/lib`
- `@/types` → `./src/types`

Always use `@/` imports for better maintainability.

### 4. Data Flow

#### API Proxy Pattern
- **Never call BGS WFS service directly from client** (CORS issues)
- Always use `/api/minerals` proxy endpoint
- The proxy is server-side Astro endpoint

**Flow**:
1. Client → `/api/minerals?commodity=copper&yearFrom=2010&yearTo=2023`
2. API proxy → BGS WFS service
3. API proxy → Returns JSON to client

#### BGS WFS Service
- Base URL: `http://ogc2.bgs.ac.uk/cgi-bin/UKWM/ows`
- Service: WFS 2.0.0
- Stored Query: `CommodityURIByYearRangeStoredQuery`
- Format: JSON
- Parameters:
  - `CGI_URL`: Commodity URI (e.g., `http://resource.geosciml.org/classifier/cgi/commodity-code/copper`)
  - `YEAR-FROM`: Start year (1970-2023)
  - `YEAR-TO`: End year (1970-2023)
  - `outputFormat`: JSON

### 5. TypeScript Types

All types defined in `src/types/minerals.ts`:
- `MineralData`: API response structure
- `MineralProperties`: Individual data point
- `FilterOptions`: Dashboard filter state
- `ChartDataPoint`: Processed chart data
- `MetricCard`: Metric display data
- `COMMODITIES`: Const array of available commodities

### 6. State Management

- Local React state using `useState`
- No external state library (Redux, Zustand, etc.)
- Filter state lives in `Dashboard.tsx`
- Props drilling for child components

### 7. Package Management

**ALWAYS use Bun, NEVER npm or pnpm**:
- Install: `bun add <package>`
- Dev install: `bun add -D <package>`
- Run scripts: `bun run <script>`
- Install all: `bun install`

### 8. Available Scripts

```bash
bun run dev      # Start dev server (localhost:4321)
bun run build    # Build for production
bun run preview  # Preview production build
```

## Key Features Implementation

### Charts (Recharts)
- `TimeSeriesChart.tsx`: Line chart for time-series data
- `ComparisonBarChart.tsx`: Bar chart for country comparisons
- Both use BGS brand color: `#003C6E`
- Responsive with `ResponsiveContainer`

### Data Table (TanStack React Table)
- Server-side rendering compatible
- Column sorting enabled
- Pagination (10 items per page)
- Export to CSV functionality

### Filters
- Commodity: Select dropdown (12 commodities)
- Year Range: Dual slider (1970-2023)
- Data Type: Radio group (Production/Imports/Exports)

### Export Functionality
- CSV: Creates blob and downloads via temporary `<a>` tag
- JSON: Same pattern as CSV
- Filenames include commodity and timestamp

## Styling & Branding

### Colors
- **Primary Brand**: `#003C6E` (BGS Blue)
- Used in: Header background, chart lines/bars
- Theme: Zinc base (neutral gray scale)

### Responsive Breakpoints
- Mobile: < 768px (stacked layout)
- Tablet: 768px - 1024px (2-column)
- Desktop: > 1024px (3-column grid)

Grid classes:
```tsx
className="grid grid-cols-1 lg:grid-cols-12 gap-6"
// Left: lg:col-span-3
// Center: lg:col-span-6
// Right: lg:col-span-3
```

## Common Tasks

### Adding a New Commodity

Edit `src/types/minerals.ts`:
```typescript
export const COMMODITIES = [
  // ... existing
  { value: 'new-commodity', label: 'New Commodity' },
] as const;
```

Value must match CGI commodity code URL format.

### Adding a New shadcn Component

```bash
bunx shadcn@latest add <component-name>
```

Component will be added to `src/components/ui/`

### Modifying Chart Colors

Update in respective component:
- `TimeSeriesChart.tsx`: Line 39 `stroke={color}`
- `ComparisonBarChart.tsx`: Line 32 `fill={color}`
- Default: `#003C6E`

### Adding New Filters

1. Update `FilterOptions` interface in `src/types/minerals.ts`
2. Add filter UI in `FilterPanel.tsx`
3. Update handler in `Dashboard.tsx`
4. Add to API call dependency array in `useEffect`

## Deployment

### GitLab Pages
- Configured in `.gitlab-ci.yml`
- Uses `oven/bun:latest` image
- Auto-deploys on push to `main` branch
- Moves `dist/` to `public/` (GitLab Pages requirement)

### Configuration for Non-Root Deployment

If deploying to `username.gitlab.io/project-name`, update `astro.config.mjs`:
```javascript
export default defineConfig({
  site: 'https://username.gitlab.io',
  base: '/project-name',
  // ...
});
```

## Known Issues & Limitations

### Tailwind CSS v4
- Cannot use custom utility classes in `@apply` directives
- Some shadcn components may need CSS adjustments
- Use direct CSS properties instead

### Chart Bundle Size
- Dashboard.tsx bundle is ~580KB (includes Recharts + TanStack Table)
- Consider code splitting if this grows larger
- Could use dynamic imports: `const Chart = lazy(() => import('./Chart'))`

### API Caching
- API proxy caches responses for 1 hour (`Cache-Control: public, max-age=3600`)
- Adjust in `src/pages/api/minerals.ts` if needed

## Dependencies to Watch

Critical dependencies:
- `@astrojs/react`: Astro React integration
- `recharts`: Charts library
- `@tanstack/react-table`: Data table
- `tailwindcss`: Styling
- `axios`: HTTP client

Dev dependencies:
- `@types/node`: Node type definitions (required for Bun)

## Testing Checklist

Before committing changes:
1. ✅ Run `bun run build` - must succeed
2. ✅ Check TypeScript errors: Look for red squiggles
3. ✅ Test in browser at multiple breakpoints
4. ✅ Verify API proxy works (check Network tab)
5. ✅ Test export functionality (CSV/JSON downloads)
6. ✅ Check console for errors/warnings

## Additional Notes

- **No Environment Variables**: Currently hardcoded API endpoint (could be extracted)
- **No Authentication**: BGS WFS is public, no auth required
- **No Error Tracking**: Could add Sentry or similar
- **No Analytics**: Could add Google Analytics or Plausible
- **Accessibility**: Follows WCAG 2.1 AA guidelines

## Getting Help

- Astro Docs: https://docs.astro.build/
- shadcn/ui: https://ui.shadcn.com/
- Recharts: https://recharts.org/
- TanStack Table: https://tanstack.com/table/latest
- BGS Data: http://ogc2.bgs.ac.uk/cgi-bin/UKWM/ows (WFS endpoint)

---

**Last Updated**: November 2024
**Astro Version**: 5.x
**React Version**: 19.x
**Tailwind CSS Version**: 4.x
